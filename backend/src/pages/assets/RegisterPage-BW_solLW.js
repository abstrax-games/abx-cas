var H=Object.defineProperty;var L=(c,n,u)=>n in c?H(c,n,{enumerable:!0,configurable:!0,writable:!0,value:u}):c[n]=u;var A=(c,n,u)=>L(c,typeof n!="symbol"?n+"":n,u);import{d as X,r as o,o as z,c as B,a,b as f,w as d,u as x,e as G,F as S,f as v,g,v as y,h as J,i as K,j as O,k,t as Q,l as W,B as _,N as Y}from"./index-CWOFgP__.js";import{a as D,B as $,A as Z,u as ee,U as ae,r as te,N as se,S as le}from"./apath-Bhetf7Vd.js";import{N as ne}from"./headers-ChCDR5PC.js";D.defaults.withCredentials=!0;class P{static async sendEmailCaptcha(n,u){var p;try{return(await D.post(`${this.backendUrl}/captcha`,{target:n,type:1,imgCaptcha:u})).data}catch(i){return i instanceof Z?(p=i.response)==null?void 0:p.data:{success:!1,message:i.message??"Error sending email captcha"}}}}A(P,"backendUrl",$.url);const oe={class:"ax-card ax-center ax-main"},ie={class:"append-text"},ue={class:"ax-register-container"},re={class:"ax-input-box"},de=["disabled"],ve={class:"ax-input-box"},pe=["disabled"],ce={class:"ax-input-box"},fe=["disabled"],xe={class:"ax-input-box"},me=["disabled"],be={class:"ax-input-box"},ge={class:"ax-input-box-group"},ye=["disabled"],he={class:"ax-button-box"},Ce={class:"ax-input-box ax-input-captcha"},we={class:"ax-input-box-group"},ke=["disabled"],_e=["src"],Se=X({__name:"RegisterPage",setup(c){const n=J(),u=K(),p=ee(),i=n.query.service||"default",t=o(!0),I=o(new le);let E=n.query.path;const U=o(""),C=o(""),N=o(""),w=o(""),V=o(""),m=o(!1),h=o(""),q=o(`${$.url}/captcha`),r=o(0),b=o(null);async function R(){h.value="",m.value=!0}async function M(){h.value="",q.value=`${$.url}/captcha?${new Date().getTime()}`}async function T(){if(t.value||r.value>0)return;t.value=!0;const s=await P.sendEmailCaptcha(w.value,h.value);t.value=!1,s.success?(r.value=60,m.value=!1,p.success({title:"发送验证码成功",duration:3e3})):(p.error({title:"发送验证码失败",content:s.message,duration:3e3}),s.lastingSeconds&&(r.value=s.lastingSeconds),s.message==="Invalid image captcha"?M():m.value=!1),b.value&&(clearInterval(b.value),b.value=null),r.value>0&&(b.value=setInterval(()=>{if(r.value<=0){clearInterval(b.value),b.value=null;return}r.value--},1e3))}async function F(){if(t.value)return;if(C.value!==N.value){p.error({title:"两次密码不一致",content:"请确认两次输入的密码一致",duration:3e3});return}t.value=!0;const s=await ae.register(U.value,w.value,C.value,V.value,i);t.value=!1,s.success?(p.success({title:"注册成功",duration:3e3}),location.href=te(n.query.path,s.tgt,s.ticket)):p.error({title:"注册失败",content:s.message,duration:3e3})}return z(async()=>{try{await I.value.fetch(i),E||(E=I.value.servicePath??`https://go.abstrax.cn/?service=${i}`),t.value=!1}catch(s){console.log(s),s.response&&s.response.status===404?u.push({path:"/error",query:{code:404,mes:`不存在名为${i}的服务`}}):u.push({path:"/error",query:{code:500,mes:`查询服务${i}信息时出错`}})}}),(s,e)=>{const j=O("router-link");return k(),B(S,null,[a("div",oe,[f(x(ne),{class:"ax-header"},{default:d(()=>e[8]||(e[8]=[v("AbstraX")])),_:1}),a("div",ie,[t.value?(k(),G(x(se),{key:0,text:"",style:{width:"60%"}})):(k(),B(S,{key:1},[v(" 注册新的 Abstrax 通行证 ")],64))]),a("div",ue,[a("div",re,[g(a("input",{class:"ax-input",type:"text","onUpdate:modelValue":e[0]||(e[0]=l=>U.value=l),placeholder:"用户名",disabled:t.value},null,8,de),[[y,U.value]]),e[9]||(e[9]=a("div",{class:"ax-input-bar"},null,-1))]),a("div",ve,[g(a("input",{class:"ax-input",type:"password","onUpdate:modelValue":e[1]||(e[1]=l=>C.value=l),placeholder:"密码",disabled:t.value},null,8,pe),[[y,C.value]]),e[10]||(e[10]=a("div",{class:"ax-input-bar"},null,-1))]),a("div",ce,[g(a("input",{class:"ax-input",type:"password","onUpdate:modelValue":e[2]||(e[2]=l=>N.value=l),placeholder:"确认密码",disabled:t.value},null,8,fe),[[y,N.value]]),e[11]||(e[11]=a("div",{class:"ax-input-bar"},null,-1))]),a("div",xe,[g(a("input",{class:"ax-input",type:"email","onUpdate:modelValue":e[3]||(e[3]=l=>w.value=l),placeholder:"邮箱",disabled:t.value},null,8,me),[[y,w.value]]),e[12]||(e[12]=a("div",{class:"ax-input-bar"},null,-1))]),a("div",be,[a("div",ge,[g(a("input",{class:"ax-input",type:"text","onUpdate:modelValue":e[4]||(e[4]=l=>V.value=l),placeholder:"邮箱验证码",disabled:t.value},null,8,ye),[[y,V.value]]),f(x(_),{type:"info",strong:"",secondary:"",style:{"border-radius":"0"},disabled:t.value||r.value>0,onClick:R},{default:d(()=>[e[13]||(e[13]=v("获取验证码")),r.value>0?(k(),B(S,{key:0},[v("("+Q(r.value)+") ",1)],64)):W("",!0)]),_:1},8,["disabled"])])])]),a("div",he,[a("div",null,[e[15]||(e[15]=v(" 已有账号，立刻")),f(j,{to:"/"},{default:d(()=>e[14]||(e[14]=[v("登录")])),_:1})]),f(x(_),{type:"info",style:{"border-radius":"0","padding-left":"40px","padding-right":"40px"},disabled:t.value,onClick:F},{default:d(()=>e[16]||(e[16]=[v("注册")])),_:1},8,["disabled"])])]),f(x(Y),{show:m.value,"onUpdate:show":e[7]||(e[7]=l=>m.value=l),preset:"dialog",title:"Dialog"},{header:d(()=>e[17]||(e[17]=[a("div",null,"图片验证码",-1)])),action:d(()=>[f(x(_),{strong:"",secondary:"",onClick:e[6]||(e[6]=l=>m.value=!1)},{default:d(()=>e[18]||(e[18]=[v("取消")])),_:1}),f(x(_),{type:"primary",onClick:T,disabled:t.value},{default:d(()=>e[19]||(e[19]=[v("确定")])),_:1},8,["disabled"])]),default:d(()=>[a("div",null,[a("div",Ce,[a("div",we,[g(a("input",{class:"ax-input",type:"text","onUpdate:modelValue":e[5]||(e[5]=l=>h.value=l),placeholder:"图片验证码",maxlength:"4",disabled:t.value},null,8,ke),[[y,h.value]]),a("img",{src:q.value,onClick:M},null,8,_e)])])])]),_:1},8,["show"]),e[20]||(e[20]=a("div",{class:"ax-light"},null,-1))],64)}}});export{Se as default};
